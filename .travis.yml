stages:
  - test
  - prepare
    if: branch = pre-release
- stage: test
  matrix:
    include:
      - language: rust
        rust:
          -  stable
          -  beta
          -  nightly
        cache: cargo
        script:
          - cd $TRAVIS_BUILD_DIR/implementations/rs
          - cargo build --all
          - cargo test --all
      - language: go
        go: master
        before_install: 
          -  export GOBIN=/home/travis/gopath/src/bin
          -  cd $TRAVIS_BUILD_DIR/implementations/go/tests
        script:
          - for pattern in ./*; do cd $pattern; go get -d ./...; go run *; cd ../; done
      - language: rust
        rust:
          -  stable
          -  beta
          -  nightly
        cache: cargo
        addons:
          firefox: latest
        script:
          -  sudo curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
          -  cd $TRAVIS_BUILD_DIR/implementations/wasm
          -  for pattern in ./*; do cd $pattern; wasm-pack test --firefox --headless; cd ..; done;
- stage: prepare
  - language: rust
    rust:
      -  stable
    cache: cargo
    script:
      -  NOISE_VER="x" 
      -  git config --global user.email "travis@travis-ci.org"
      -  git config --global user.name "Travis CI"
      -  sudo curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      -  git checkout master > /dev/null 2>&1
      -  git merge --squash pre-release > /dev/null 2>&1
      -  cd $TRAVIS_BUILD_DIR/src
      -  make wasm
      -  cd ../
      -  git add * > /dev/null 2>&1
      -  git commit -m "Release Noise Explorer v${NOISE_VER}" > /dev/null 2>&1
      -  git remote rm origin
      -  git remote add origin https://georgio:${GH_TOKEN}@github.com/SymbolicSoft/noiseexplorer.git > /dev/null 2>&1
      -  git push origin master --quiet > /dev/null 2>&1
      -  git tag -a v${NOISE_VER} -m "Noise Explorer v${NOISE_VER}"  > /dev/null 2>&1
      -  git push --tags > /dev/null 2>&1  > /dev/null 2>&1